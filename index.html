<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Dom Nowaka PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#020617">
  <link rel="manifest" href="manifest.json">

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('service-worker.js')
          .catch(err => {
            console.log('Błąd rejestracji Service Workera:', err);
          });
      });
    }
  </script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      padding: 16px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .header h1 { font-size: 1.4rem; }
    .muted { font-size: 0.8rem; color: #9ca3af; }
    h2 { font-size: 1rem; margin: 16px 0 8px; border-bottom: 1px solid #1f2937; padding-bottom: 4px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    .card {
      background: #030712;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #111827;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .card-title {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      color: #e5e7eb;
    }
    .pill-person {
      border-color: #60a5fa;
      background: rgba(37,99,235,0.2);
    }
    .pill-today {
      border-color: #22c55e;
      background: rgba(34,197,94,0.15);
      color: #bbf7d0;
    }
    .pill-prio-high {
      border-color: #f97316;
      background: rgba(248,113,113,0.12);
      color: #fed7d7;
    }
    .pill-prio-low {
      border-color: #6b7280;
      background: rgba(55,65,81,0.8);
      color: #e5e7eb;
    }
    .cat-tile {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: 16px;
      border: 2px solid #1f2937;
      padding: 12px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 80px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .cat-tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.6);
      background: radial-gradient(circle at top left, #1f2937, #020617);
    }
    .cat-tile-title {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .cat-tile-sub {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 4px;
    }
    .cat-tile-footer {
      margin-top: 6px;
      font-size: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .tag {
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 2px 8px;
      font-size: 0.75rem;
    }
    .color-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid #111827;
    }
    .back-btn {
      background: #020617;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      font-size: 0.9rem;
      cursor: pointer;
      padding: 8px 16px;
      margin-bottom: 12px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .back-btn:hover { background: #030712; }
    .section-label {
      font-size: 0.85rem;
      font-weight: 600;
      margin: 10px 0 4px;
    }
    .small-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    input, textarea, select, button { font: inherit; }
    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="time"],
    textarea,
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .btn-primary:hover { background: #16a34a; }
    .btn-danger {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      background: #b91c1c;
      color: #fee2e2;
      font-weight: 500;
      font-size: 0.75rem;
      margin-left: 6px;
    }
    .btn-secondary {
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 6px 10px;
      cursor: pointer;
      background: #020617;
      color: #e5e7eb;
      font-weight: 500;
      font-size: 0.75rem;
    }
    .btn-secondary:hover { background: #030712; }

    .two-cols {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }
    @media (max-width: 640px) {
      .two-cols { grid-template-columns: 1fr; }
      .header { flex-direction: column; align-items: flex-start; }
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #030712;
      border: 1px solid #111827;
    }
    .filter-label {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-right: 4px;
    }
    .filter-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .filter-btn.active {
      background: #22c55e;
      color: #022c22;
      border-color: #22c55e;
      font-weight: 600;
    }

    .person-btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .person-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .person-btn:hover {
      background: #111827;
    }

    .settings-btn {
      background: #020617;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .settings-btn:hover {
      background: #030712;
    }
    .settings-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 0.85rem;
    }

    .task-image {
      margin-top: 6px;
      border-radius: 8px;
      max-height: 180px;
      width: 100%;
      object-fit: cover;
      border: 1px solid #111827;
    }

    .category-header-accent {
      border-left: 4px solid #22c55e;
      padding-left: 8px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <header class="header">
    <div>
      <h1 id="homeNameHeader">Dom Nowaka</h1>
      <div class="muted" id="todayText"></div>
    </div>
    <button class="settings-btn" onclick="openSettings()">
      ⚙ <span>Ustawienia</span>
    </button>
  </header>

  <main id="viewDashboard">
    <div id="summaryCard"></div>

    <div class="filter-bar">
      <span class="filter-label">Osoby (filtr):</span>
      <button class="filter-btn" id="filterAll" onclick="setPersonFilter('ALL')">Wszyscy</button>
      <button class="filter-btn" id="filterJacek" onclick="setPersonFilter('JACEK')">
        <span id="filterLabelJacek">Jacek</span>
      </button>
      <button class="filter-btn" id="filterGrazyna" onclick="setPersonFilter('GRAZYNA')">
        <span id="filterLabelGrazyna">Grażyna</span>
      </button>
      <button class="filter-btn" id="filterRodzina" onclick="setPersonFilter('RODZINA')">Rodzina</button>
    </div>

    <h2>Dzisiaj — do zrobienia</h2>
    <div id="todayList"></div>

    <h2>Jutro</h2>
    <div id="tomorrowList"></div>

    <h2>Najbliższe ur./im./rocznice</h2>
    <div id="birthdaysList"></div>

    <h2>Zaległe</h2>
    <div id="overdueList"></div>

    <h2 style="margin-top:18px;">Kategorie</h2>
    <div class="grid" id="categoriesGrid"></div>
  </main>

  <main id="viewCategory" style="display:none;">
    <button class="back-btn" onclick="goHome()">← <span>Powrót</span></button>
    <div id="categoryHeader" class="category-header-accent">
      <h2 id="categoryTitle" style="border:none;margin:0;"></h2>
    </div>
    <div id="categoryContent"></div>
  </main>

  <main id="viewSettings" style="display:none;">
    <button class="back-btn" onclick="goHome()">← <span>Powrót</span></button>
    <h2>Ustawienia</h2>

    <div class="card">
      <div class="section-label">Nazwa domu</div>
      <div class="small-label">Tekst w nagłówku i tytule strony</div>
      <input id="settingsHomeName" type="text" placeholder="Np. Dom Nowaka, Family Hub, itp.">
      <div style="margin-top:8px; text-align:right;">
        <button class="btn-primary" onclick="saveHomeName()">Zapisz nazwę</button>
      </div>
    </div>

    <div class="card">
      <div class="section-label">Kategorie</div>
      <div class="small-label">
        Możesz ukrywać, zmieniać nazwy i usuwać wszystkie kategorie.
      </div>
      <div id="settingsCategories"></div>
    </div>

    <div class="card">
      <div class="section-label">Osoby / rodzina</div>
      <div class="small-label">Pierwsze dwie osoby to Jacek i Grażyna. Poniżej możesz dodać członków rodziny.</div>
      <div id="settingsPersons"></div>
      <div style="margin-top:8px; text-align:right;">
        <button class="btn-primary" onclick="savePersonNames()">Zapisz osoby</button>
      </div>
    </div>

    <div class="card">
  <div class="section-label">Kopia zapasowa</div>
  <div class="small-label">
    Eksportuj wszystkie dane do pliku .json albo wczytaj je z powrotem z pliku.
  </div>

  <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;">
    <button class="btn-primary" onclick="exportData()">Eksportuj dane</button>

    <label class="btn-secondary" style="display:inline-flex; align-items:center; gap:6px; cursor:pointer;">
      Importuj dane
      <input
        type="file"
        id="importFile"
        accept="application/json"
        style="display:none;"
        onchange="importData(event)"
      >
    </label>
  </div>

  <p class="small-label" style="margin-top:6px;">
    Import nadpisze aktualne ustawienia i zadania danymi z pliku (sam plik zostaje na dysku).
  </p>
</div>

  </main>

  <script>
    const DEFAULT_PERSONS = [
      "Jacek", "Grażyna", "", "", "", "", "", ""
    ];

    const STORAGE_KEY = "dom_nowaka_baza_v2";

    const BUILTIN_CATEGORIES = [
      { key:"lasocice",   defaultLabel:"Lasocice",        sub:"Dom · Działka · Rachunki" },
      { key:"boszkowo",   defaultLabel:"Boszkowo",        sub:"Dom · Działka · Rachunki" },
      { key:"auto",       defaultLabel:"Auto",            sub:"Serwis, przeglądy, naprawy" },
      { key:"firma",      defaultLabel:"Firma",           sub:"Sprawy firmowe i zadania" },
      { key:"zdrowie",    defaultLabel:"Zdrowie",         sub:"Wizyty, badania, lekarze" },
      { key:"czaswolny",  defaultLabel:"Czas wolny",      sub:"Plany, wyjazdy, spotkania" },
      { key:"events",     defaultLabel:"Ur/Im/Rocznice",  sub:"Urodziny, imieniny, rocznice" },
      { key:"osoby",      defaultLabel:"Osoby",           sub:"Przegląd zadań wg osoby" }
    ];

    let state = {
      lasociceDom: [],
      lasociceDzialka: [],
      lasociceBills: [],
      boszkowoDom: [],
      boszkowoDzialka: [],
      boszkowoBills: [],
      auto: [],
      firma: [],
      zdrowie: [],
      czaswolny: [],
      events: [],
      customCategories: [],
      customData: {},
      settings: {
        homeName: "Dom Nowaka",
        visibleCategories: {
          lasocice: true,
          boszkowo: true,
          auto: true,
          firma: true,
          zdrowie: true,
          czaswolny: true,
          events: true,
          osoby: true
        },
        categoryLabels: {
          lasocice: "Lasocice",
          boszkowo: "Boszkowo",
          auto: "Auto",
          firma: "Firma",
          zdrowie: "Zdrowie",
          czaswolny: "Czas wolny",
          events: "Ur/Im/Rocznice",
          osoby: "Osoby"
        },
        categoryColors: {},
        personNames: DEFAULT_PERSONS.slice()
      }
    };

    let currentCategory = null;
    let currentPersonFilter = "ALL";

    function todayISO() {
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
    }

    function addDaysISO(dateStr, days) {
      const [y,m,d] = dateStr.split("-").map(x => parseInt(x,10));
      const dt = new Date(y, m-1, d);
      dt.setDate(dt.getDate() + days);
      const pad = n => String(n).padStart(2,"0");
      return dt.getFullYear()+"-"+pad(dt.getMonth()+1)+"-"+pad(dt.getDate());
    }

    function makeDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split("-");
      if (parts.length < 3) return null;
      const y = parseInt(parts[0],10);
      const m = parseInt(parts[1],10);
      const d = parseInt(parts[2],10);
      if (isNaN(y)||isNaN(m)||isNaN(d)) return null;
      return new Date(y, m-1, d);
    }

    function dateDiffDays(aStr, bStr) {
      const a = makeDate(aStr);
      const b = makeDate(bStr);
      if (!a || !b) return null;
      const ms = b.getTime() - a.getTime();
      return Math.round(ms / (1000*60*60*24));
    }

    function calcAge(dateStr) {
      const base = makeDate(dateStr);
      if (!base) return null;
      const today = new Date();
      let age = today.getFullYear() - base.getFullYear();
      const tM = today.getMonth() + 1;
      const tD = today.getDate();
      const [y,m,d] = dateStr.split("-").map(x => parseInt(x,10));
      if (tM < m || (tM === m && tD < d)) age--;
      return age;
    }

    function isTaskDueOn(task, targetISO) {
      if (!task.date) return false;
      const baseISO = task.date;
      const repeat = task.repeat || "none";
      if (repeat === "none") {
        return baseISO === targetISO;
      }
      const base = makeDate(baseISO);
      const target = makeDate(targetISO);
      if (!base || !target) return false;
      if (target.getTime() < base.getTime()) return false;

      if (repeat === "weekly") {
        const diff = dateDiffDays(baseISO, targetISO);
        if (diff == null) return false;
        return diff % 7 === 0;
      }
      if (repeat === "monthly") {
        const bd = base.getDate();
        return target.getDate() === bd;
      }
      if (repeat === "yearly") {
        return target.getMonth() === base.getMonth() && target.getDate() === base.getDate();
      }
      return false;
    }

    function getNextYearlyOccurrence(dateStr) {
      const base = makeDate(dateStr);
      if (!base) return null;
      const today = new Date();
      const thisYear = today.getFullYear();
      const month = base.getMonth();
      const day = base.getDate();
      let candidate = new Date(thisYear, month, day);
      if (candidate < new Date(today.getFullYear(), today.getMonth(), today.getDate())) {
        candidate = new Date(thisYear+1, month, day);
      }
      const pad = n => String(n).padStart(2,"0");
      return candidate.getFullYear()+"-"+pad(candidate.getMonth()+1)+"-"+pad(candidate.getDate());
    }

    function ensureSettingsDefaults() {
      if (!state.settings) state.settings = {};
      if (!state.settings.homeName) state.settings.homeName = "Dom Nowaka";

      const defVis = {
        lasocice: true,
        boszkowo: true,
        auto: true,
        firma: true,
        zdrowie: true,
        czaswolny: true,
        events: true,
        osoby: true
      };
      if (!state.settings.visibleCategories) {
        state.settings.visibleCategories = Object.assign({}, defVis);
      } else {
        for (const k in defVis) {
          if (typeof state.settings.visibleCategories[k] === "undefined") {
            state.settings.visibleCategories[k] = defVis[k];
          }
        }
      }

      const defLabels = {
        lasocice: "Lasocice",
        boszkowo: "Boszkowo",
        auto: "Auto",
        firma: "Firma",
        zdrowie: "Zdrowie",
        czaswolny: "Czas wolny",
        events: "Ur/Im/Rocznice",
        osoby: "Osoby"
      };
      if (!state.settings.categoryLabels) {
        state.settings.categoryLabels = Object.assign({}, defLabels);
      } else {
        for (const k in defLabels) {
          if (!state.settings.categoryLabels[k]) {
            state.settings.categoryLabels[k] = defLabels[k];
          }
        }
      }

      if (!state.settings.categoryColors) {
        state.settings.categoryColors = {};
      }

      if (!state.settings.personNames || !Array.isArray(state.settings.personNames)) {
        state.settings.personNames = DEFAULT_PERSONS.slice();
      } else if (state.settings.personNames.length < DEFAULT_PERSONS.length) {
        for (let i = 0; i < DEFAULT_PERSONS.length; i++) {
          if (typeof state.settings.personNames[i] === "undefined") {
            state.settings.personNames[i] = DEFAULT_PERSONS[i];
          }
        }
      }

      if (!Array.isArray(state.customCategories)) {
        state.customCategories = [];
      }
      if (!state.customData || typeof state.customData !== "object") {
        state.customData = {};
      }
      if (!Array.isArray(state.events)) {
        state.events = [];
      }
    }

    function ensureCustomData(catId) {
      if (!state.customData) state.customData = {};
      if (!state.customData[catId]) state.customData[catId] = [];
      return state.customData[catId];
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          state = Object.assign(state, parsed);
        }
      } catch (e) {
        console.error("Błąd wczytywania", e);
      }
      ensureSettingsDefaults();
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      applyDynamicTexts();
      renderDashboard();
      renderCategoriesTiles();
      if (currentCategory) {
        openCategory(currentCategory);
      }
    }

    function renderTodayHeader() {
      const d = new Date();
      const dni = ["Niedziela","Poniedziałek","Wtorek","Środa","Czwartek","Piątek","Sobota"];
      const pad = n => String(n).padStart(2,"0");
      const txt = dni[d.getDay()] + ", " + pad(d.getDate()) + "." + pad(d.getMonth()+1) + "." + d.getFullYear();
      document.getElementById("todayText").textContent = txt;
    }

    function getPersonNames() {
      ensureSettingsDefaults();
      return state.settings.personNames || DEFAULT_PERSONS;
    }

    function personName(idx) {
      const arr = getPersonNames();
      return (idx != null && idx >=0 && idx < arr.length)
        ? (arr[idx] || ("Osoba " + (idx+1)))
        : "";
    }

    function getCategoryLabel(key, fallback) {
      ensureSettingsDefaults();
      const map = state.settings.categoryLabels || {};
      return map[key] || fallback;
    }

    function getCategoryColorRaw(key) {
      ensureSettingsDefaults();
      const map = state.settings.categoryColors || {};
      const defaults = {
        lasocice: "#22c55e",
        boszkowo: "#3b82f6",
        auto: "#f97316",
        firma: "#a855f7",
        zdrowie: "#ef4444",
        czaswolny: "#eab308",
        events: "#ec4899",
        osoby: "#0ea5e9"
      };
      return map[key] || defaults[key] || "#4b5563";
    }

    function getCustomCategoryColorKey(id) {
      return "custom_" + id;
    }

    function applyDynamicTexts() {
      ensureSettingsDefaults();
      const homeName = state.settings.homeName || "Dom Nowaka";
      const h = document.getElementById("homeNameHeader");
      if (h) h.textContent = homeName;
      document.title = homeName;

      const persons = getPersonNames();
      const jSpan = document.getElementById("filterLabelJacek");
      const gSpan = document.getElementById("filterLabelGrazyna");
      if (jSpan) jSpan.textContent = persons[0] || "Jacek";
      if (gSpan) gSpan.textContent = persons[1] || "Grażyna";
    }

    function renderCategoriesTiles() {
      const grid = document.getElementById("categoriesGrid");
      grid.innerHTML = "";
      const vis = state.settings.visibleCategories || {};

      BUILTIN_CATEGORIES.forEach(cat => {
        if (vis[cat.key] === false) return;
        const tile = document.createElement("div");
        tile.className = "cat-tile";
        const color = getCategoryColorRaw(cat.key);
        tile.style.borderColor = color;
        tile.innerHTML = `
          <div>
            <div class="cat-tile-title">${getCategoryLabel(cat.key, cat.defaultLabel)}</div>
            <div class="cat-tile-sub">${cat.sub}</div>
          </div>
          <div class="cat-tile-footer">
            <span class="tag">Otwórz</span>
            <span class="color-dot" style="background:${color};"></span>
          </div>
        `;
        tile.addEventListener("click", () => openCategory(cat.key));
        grid.appendChild(tile);
      });

      (state.customCategories || []).forEach(cat => {
        if (cat.visible === false) return;
        const tile = document.createElement("div");
        tile.className = "cat-tile";
        const colorKey = getCustomCategoryColorKey(cat.id);
        const color = state.settings.categoryColors[colorKey] || "#6b7280";
        tile.style.borderColor = color;
        tile.innerHTML = `
          <div>
            <div class="cat-tile-title">${cat.name}</div>
            <div class="cat-tile-sub">Lista zadań</div>
          </div>
          <div class="cat-tile-footer">
            <span class="tag">Otwórz</span>
            <span class="color-dot" style="background:${color};"></span>
          </div>
        `;
        tile.addEventListener("click", () => openCategory("custom:" + cat.id));
        grid.appendChild(tile);
      });
    }

    function priorityLabel(priority) {
      if (priority === "high") return "Wysoki";
      if (priority === "low") return "Niski";
      return "Normalny";
    }

    function priorityOrder(priority) {
      if (priority === "high") return 0;
      if (priority === "low") return 2;
      return 1;
    }

    function personMatchesFilter(personIndex) {
      if (personIndex == null) {
        return currentPersonFilter === "ALL";
      }
      if (currentPersonFilter === "ALL") return true;
      if (currentPersonFilter === "JACEK") return personIndex === 0;
      if (currentPersonFilter === "GRAZYNA") return personIndex === 1;
      if (currentPersonFilter === "RODZINA") {
        return personIndex >= 2 && personIndex <= 7;
      }
      return true;
    }

    function updateFilterButtons() {
      const ids = ["filterAll","filterJacek","filterGrazyna","filterRodzina"];
      ids.forEach(id => {
        const btn = document.getElementById(id);
        if (!btn) return;
        btn.classList.remove("active");
      });
      if (currentPersonFilter === "ALL") {
        document.getElementById("filterAll").classList.add("active");
      } else if (currentPersonFilter === "JACEK") {
        document.getElementById("filterJacek").classList.add("active");
      } else if (currentPersonFilter === "GRAZYNA") {
        document.getElementById("filterGrazyna").classList.add("active");
      } else if (currentPersonFilter === "RODZINA") {
        document.getElementById("filterRodzina").classList.add("active");
      }
    }

    function setPersonFilter(filter) {
      currentPersonFilter = filter;
      updateFilterButtons();
      renderDashboard();
    }

    function addDashboardCard(container, title, categoryLabel, person, extra, priority, statusLabel) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">${title}</div>
            <div class="muted">${categoryLabel}</div>
          </div>
        </div>
      `;
      const pills = document.createElement("div");
      pills.className = "pill-row";
      if (person) {
        const p1 = document.createElement("span");
        p1.className = "pill pill-person";
        p1.textContent = person;
        pills.appendChild(p1);
      }
      if (statusLabel) {
        const p2 = document.createElement("span");
        p2.className = "pill pill-today";
        p2.textContent = statusLabel;
        pills.appendChild(p2);
      }
      if (priority && priority !== "normal") {
        const p3 = document.createElement("span");
        p3.className = "pill " + (priority === "high" ? "pill-prio-high" : "pill-prio-low");
        p3.textContent = "Priorytet: " + priorityLabel(priority);
        pills.appendChild(p3);
      }
      if (extra) {
        const p4 = document.createElement("span");
        p4.className = "pill";
        p4.textContent = extra;
        pills.appendChild(p4);
      }
      card.appendChild(pills);
      container.appendChild(card);
    }

    function renderDashboard() {
      const today = todayISO();
      const tomorrow = addDaysISO(today, 1);

      const todayList = document.getElementById("todayList");
      const tomorrowList = document.getElementById("tomorrowList");
      const birthdaysList = document.getElementById("birthdaysList");
      const overdueList = document.getElementById("overdueList");
      const summaryCard = document.getElementById("summaryCard");

      todayList.innerHTML = "";
      tomorrowList.innerHTML = "";
      birthdaysList.innerHTML = "";
      overdueList.innerHTML = "";
      summaryCard.innerHTML = "";

      let todayCount = 0;
      let todayHighCount = 0;
      let tomorrowCount = 0;
      let overdueCount = 0;

      const overdueEntries = [];
      const vis = state.settings.visibleCategories || {};

      function processTaskArray(arr, categoryLabel) {
        arr.forEach(t => {
          const priority = t.priority || "normal";
          const isToday = isTaskDueOn(t, today);
          const isTomorrow = isTaskDueOn(t, tomorrow);
          const isOverdue = (!t.repeat || t.repeat === "none") && t.date && t.date < today;

          if (isToday && personMatchesFilter(t.personIndex)) {
            addDashboardCard(todayList, t.title, categoryLabel, personName(t.personIndex), null, priority, "Dzisiaj");
            todayCount++;
            if (priority === "high") todayHighCount++;
          }
          if (isTomorrow && personMatchesFilter(t.personIndex)) {
            addDashboardCard(tomorrowList, t.title, categoryLabel, personName(t.personIndex), null, priority, "Jutro");
            tomorrowCount++;
          }
          if (isOverdue && personMatchesFilter(t.personIndex)) {
            overdueEntries.push({
              title: t.title,
              category: categoryLabel,
              personIndex: t.personIndex,
              priority,
              date: t.date
            });
            overdueCount++;
          }
        });
      }

      if (vis.lasocice !== false) {
        processTaskArray(state.lasociceDom, getCategoryLabel("lasocice","Lasocice") + " – Dom");
        processTaskArray(state.lasociceDzialka, getCategoryLabel("lasocice","Lasocice") + " – Działka");
        state.lasociceBills.forEach(b => {
          if (b.due === today && personMatchesFilter(null)) {
            addDashboardCard(todayList, "Rachunek: " + b.name, getCategoryLabel("lasocice","Lasocice") + " – Rachunki", null, b.amount ? (b.amount + " zł") : null, "normal", "Dzisiaj");
            todayCount++;
          }
          if (b.due === tomorrow && personMatchesFilter(null)) {
            addDashboardCard(tomorrowList, "Rachunek: " + b.name, getCategoryLabel("lasocice","Lasocice") + " – Rachunki", null, b.amount ? (b.amount + " zł") : null, "normal", "Jutro");
            tomorrowCount++;
          }
          if (b.due < today && personMatchesFilter(null)) {
            overdueEntries.push({
              title: "Rachunek: " + b.name,
              category: getCategoryLabel("lasocice","Lasocice") + " – Rachunki",
              personIndex: null,
              priority: "normal",
              date: b.due
            });
            overdueCount++;
          }
        });
      }

      if (vis.boszkowo !== false) {
        processTaskArray(state.boszkowoDom, getCategoryLabel("boszkowo","Boszkowo") + " – Dom");
        processTaskArray(state.boszkowoDzialka, getCategoryLabel("boszkowo","Boszkowo") + " – Działka");
        state.boszkowoBills.forEach(b => {
          if (b.due === today && personMatchesFilter(null)) {
            addDashboardCard(todayList, "Rachunek: " + b.name, getCategoryLabel("boszkowo","Boszkowo") + " – Rachunki", null, b.amount ? (b.amount + " zł") : null, "normal", "Dzisiaj");
            todayCount++;
          }
          if (b.due === tomorrow && personMatchesFilter(null)) {
            addDashboardCard(tomorrowList, "Rachunek: " + b.name, getCategoryLabel("boszkowo","Boszkowo") + " – Rachunki", null, b.amount ? (b.amount + " zł") : null, "normal", "Jutro");
            tomorrowCount++;
          }
          if (b.due < today && personMatchesFilter(null)) {
            overdueEntries.push({
              title: "Rachunek: " + b.name,
              category: getCategoryLabel("boszkowo","Boszkowo") + " – Rachunki",
              personIndex: null,
              priority: "normal",
              date: b.due
            });
            overdueCount++;
          }
        });
      }

      if (vis.auto !== false) {
        processTaskArray(state.auto, getCategoryLabel("auto","Auto"));
      }
      if (vis.firma !== false) {
        processTaskArray(state.firma, getCategoryLabel("firma","Firma"));
      }
      if (vis.czaswolny !== false) {
        processTaskArray(state.czaswolny, getCategoryLabel("czaswolny","Czas wolny"));
      }

      if (vis.zdrowie !== false) {
        state.zdrowie.forEach(t => {
          const priority = t.priority || "normal";
          const isToday = isTaskDueOn(t, today);
          const isTomorrow = isTaskDueOn(t, tomorrow);
          const isOverdue = (!t.repeat || t.repeat === "none") && t.date && t.date < today;
          const label = getCategoryLabel("zdrowie","Zdrowie") + " – " + (t.place || "wizyta");

          if (isToday && personMatchesFilter(t.personIndex)) {
            addDashboardCard(todayList, t.type, label, personName(t.personIndex), t.time || null, priority, "Dzisiaj");
            todayCount++;
            if (priority === "high") todayHighCount++;
          }
          if (isTomorrow && personMatchesFilter(t.personIndex)) {
            addDashboardCard(tomorrowList, t.type, label, personName(t.personIndex), t.time || null, priority, "Jutro");
            tomorrowCount++;
          }
          if (isOverdue && personMatchesFilter(t.personIndex)) {
            overdueEntries.push({
              title: t.type,
              category: label,
              personIndex: t.personIndex,
              priority,
              date: t.date
            });
            overdueCount++;
          }
        });
      }

      (state.customCategories || []).forEach(cat => {
        if (cat.visible === false) return;
        const arr = ensureCustomData(cat.id);
        arr.forEach(t => {
          const priority = t.priority || "normal";
          const isToday = isTaskDueOn(t, today);
          const isTomorrow = isTaskDueOn(t, tomorrow);
          const isOverdue = (!t.repeat || t.repeat === "none") && t.date && t.date < today;

          if (isToday && personMatchesFilter(t.personIndex)) {
            addDashboardCard(todayList, t.title, cat.name, personName(t.personIndex), null, priority, "Dzisiaj");
            todayCount++;
            if (priority === "high") todayHighCount++;
          }
          if (isTomorrow && personMatchesFilter(t.personIndex)) {
            addDashboardCard(tomorrowList, t.title, cat.name, personName(t.personIndex), null, priority, "Jutro");
            tomorrowCount++;
          }
          if (isOverdue && personMatchesFilter(t.personIndex)) {
            overdueEntries.push({
              title: t.title,
              category: cat.name,
              personIndex: t.personIndex,
              priority,
              date: t.date
            });
            overdueCount++;
          }
        });
      });

      const allEvents = (vis.events === false) ? [] : (state.events || []);
      const upcoming = [];
      const todayDateObj = new Date();
      const tm = todayDateObj.getMonth()+1;
      const td = todayDateObj.getDate();

      allEvents.forEach(e => {
        if (!e.date) return;
        const [y,m,d] = e.date.split("-").map(x => parseInt(x,10));
        if (!isNaN(m) && !isNaN(d) && m === tm && d === td) {
          let title;
          const kindLabel = e.kind === "imieniny" ? "Imieniny" : (e.kind === "rocznica" ? "Rocznica" : "Urodziny");
          if (e.kind === "urodziny") {
            const age = calcAge(e.date);
            title = kindLabel + ": " + (e.personName || "-");
            if (age != null) title += " (" + age + " lat)";
          } else {
            title = kindLabel + ": " + (e.personName || "-");
          }
          addDashboardCard(
            todayList,
            title,
            getCategoryLabel("events","Ur/Im/Rocznice"),
            null,
            null,
            "high",
            "Dzisiaj"
          );
          todayCount++;
          todayHighCount++;
        }
        const nextISO = getNextYearlyOccurrence(e.date);
if (!nextISO) return;
const diff = dateDiffDays(today, nextISO);

// pokazuj tylko jeśli uroczystość jest w ciągu 30 dni
if (diff == null || diff < 0 || diff > 30) return;

upcoming.push({entry:e, nextISO, diff});

      });

      upcoming.sort((a,b) => a.diff - b.diff);
      const topUp = upcoming.slice(0, 3);

      if (!topUp.length) {
        const emptyB = document.createElement("div");
        emptyB.className = "card";
        emptyB.innerHTML = `<span class="muted">Brak nadchodzących uroczystości.</span>`;
        birthdaysList.appendChild(emptyB);
      } else {
        topUp.forEach(u => {
          const e = u.entry;
          const diff = u.diff;
          const kindLabel = e.kind === "imieniny" ? "Imieniny" : (e.kind === "rocznica" ? "Rocznica" : "Urodziny");
          let title = kindLabel + ": " + (e.personName || "");
          if (e.kind === "urodziny") {
            const age = calcAge(e.date);
            if (age != null) title += " (" + age + " lat)";
          }
          const extra = diff === 0 ? "dzisiaj" : ("za " + diff + " dni");
          addDashboardCard(
            birthdaysList,
            title,
            getCategoryLabel("events","Ur/Im/Rocznice"),
            null,
            extra,
            "high",
            "Uroczystość"
          );
        });
      }

      if (!overdueEntries.length) {
        const emptyO = document.createElement("div");
        emptyO.className = "card";
        emptyO.innerHTML = `<span class="muted">Brak zaległych zadań dla wybranego filtra.</span>`;
        overdueList.appendChild(emptyO);
      } else {
        overdueEntries
          .sort((a,b) => {
            const pA = priorityOrder(a.priority);
            const pB = priorityOrder(b.priority);
            if (pA !== pB) return pA - pB;
            return (a.date || "").localeCompare(b.date || "");
          })
          .forEach(o => {
            const status = "Zaległe";
            const catLabel = o.category + (o.date ? (" • " + o.date) : "");
            addDashboardCard(overdueList, o.title, catLabel, personName(o.personIndex), null, o.priority, status);
          });
      }

      if (!todayCount) {
        const emptyT = document.createElement("div");
        emptyT.className = "card";
        emptyT.innerHTML = `<span class="muted">Dzisiaj nie ma żadnych zadań dla wybranego filtra.</span>`;
        todayList.appendChild(emptyT);
      }
      if (!tomorrowCount) {
        const emptyTom = document.createElement("div");
        emptyTom.className = "card";
        emptyTom.innerHTML = `<span class="muted">Na jutro nic nie zaplanowano dla wybranego filtra.</span>`;
        tomorrowList.appendChild(emptyTom);
      }

      const card = document.createElement("div");
      card.className = "card";
      let text = `Dzisiaj: ${todayCount} zadań`;
      if (todayHighCount) text += ` (z czego ${todayHighCount} o wysokim priorytecie)`;
      text += `. Jutro: ${tomorrowCount} zadań. Zaległe: ${overdueCount}.`;

      const upcomingShort = topUp.slice(0,1)[0];
      if (upcomingShort) {
        const e = upcomingShort.entry;
        const diff = upcomingShort.diff;
        const who = e.personName || "ktoś z rodziny";
        if (diff === 0) {
          text += ` Dziś jest uroczystość: ${who}.`;
        } else {
          text += ` Najbliższa uroczystość: ${who} za ${diff} dni.`;
        }
      }

      card.innerHTML = `
        <div class="card-title">Podsumowanie</div>
        <p style="font-size:0.85rem; margin-top:4px;">${text}</p>
      `;
      summaryCard.appendChild(card);
    }

    function goHome() {
      currentCategory = null;
      document.getElementById("viewDashboard").style.display = "block";
      document.getElementById("viewCategory").style.display = "none";
      document.getElementById("viewSettings").style.display = "none";
    }

    function openCategory(key) {
      currentCategory = key;
      document.getElementById("viewDashboard").style.display = "none";
      document.getElementById("viewCategory").style.display = "block";
      document.getElementById("viewSettings").style.display = "none";

      const titleEl = document.getElementById("categoryTitle");
      const header = document.getElementById("categoryHeader");
      const content = document.getElementById("categoryContent");
      content.innerHTML = "";

      let label = key;
      if (key === "lasocice") label = getCategoryLabel("lasocice","Lasocice");
      else if (key === "boszkowo") label = getCategoryLabel("boszkowo","Boszkowo");
      else if (key === "auto") label = getCategoryLabel("auto","Auto");
      else if (key === "firma") label = getCategoryLabel("firma","Firma");
      else if (key === "zdrowie") label = getCategoryLabel("zdrowie","Zdrowie");
      else if (key === "czaswolny") label = getCategoryLabel("czaswolny","Czas wolny");
      else if (key === "events") label = getCategoryLabel("events","Ur/Im/Rocznice");
      else if (key === "osoby") label = getCategoryLabel("osoby","Osoby");
      else if (key.startsWith("custom:")) {
        const id = parseInt(key.split(":")[1],10);
        const cat = (state.customCategories || []).find(c => c.id === id);
        label = cat ? cat.name : "Kategoria";
      }
      titleEl.textContent = label;

      let color = "#22c55e";
      if (key.startsWith("custom:")) {
        const id = parseInt(key.split(":")[1],10);
        const cKey = getCustomCategoryColorKey(id);
        color = state.settings.categoryColors[cKey] || "#6b7280";
      } else {
        color = getCategoryColorRaw(key);
      }
      header.style.borderLeftColor = color;

      if (key === "lasocice") {
        renderLasocice(content);
      } else if (key === "boszkowo") {
        renderBoszkowo(content);
      } else if (key === "auto") {
        renderSimpleCategory(content, getCategoryLabel("auto","Auto"), "auto");
      } else if (key === "firma") {
        renderSimpleCategory(content, getCategoryLabel("firma","Firma"), "firma");
      } else if (key === "zdrowie") {
        renderZdrowie(content);
      } else if (key === "czaswolny") {
        renderSimpleCategory(content, getCategoryLabel("czaswolny","Czas wolny"), "czaswolny");
      } else if (key === "osoby") {
        renderOsoby(content);
      } else if (key === "events") {
        renderEvents(content);
      } else if (key.startsWith("custom:")) {
        const id = parseInt(key.split(":")[1],10);
        const cat = (state.customCategories || []).find(c => c.id === id);
        if (!cat) {
          content.innerHTML = `<div class="card"><span class="muted">Ta kategoria została usunięta.</span></div>`;
          return;
        }
        renderCustomSimpleCategory(content, cat);
      }
    }

    function openSettings() {
      currentCategory = null;
      document.getElementById("viewDashboard").style.display = "none";
      document.getElementById("viewCategory").style.display = "none";
      document.getElementById("viewSettings").style.display = "block";
      renderSettings();
    }

    function renderPersonSelect(selectEl) {
      const persons = getPersonNames();
      selectEl.innerHTML = "";
      const optEmpty = document.createElement("option");
      optEmpty.value = "";
      optEmpty.textContent = "- brak -";
      selectEl.appendChild(optEmpty);
      persons.forEach((p, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = p || ("Osoba " + (idx+1));
        selectEl.appendChild(opt);
      });
    }

    function renderPrioritySelect(selectEl) {
      selectEl.innerHTML = "";
      const opts = [
        {value:"normal", label:"Normalny"},
        {value:"high", label:"Wysoki"},
        {value:"low", label:"Niski"}
      ];
      opts.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        selectEl.appendChild(opt);
      });
    }

    function renderRepeatSelect(selectEl) {
      selectEl.innerHTML = "";
      const opts = [
        {value:"none", label:"Brak"},
        {value:"weekly", label:"Co tydzień"},
        {value:"monthly", label:"Co miesiąc"},
        {value:"yearly", label:"Co rok"}
      ];
      opts.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        selectEl.appendChild(opt);
      });
    }

    function repeatLabel(repeat) {
      if (repeat === "weekly") return "co tydzień";
      if (repeat === "monthly") return "co miesiąc";
      if (repeat === "yearly") return "co rok";
      return "brak";
    }

    function editSimpleTask(item, updateFn) {
      const newTitle = prompt("Nowy tytuł (puste = bez zmian):", item.title || "");
      if (newTitle === null) return;
      const newDate = prompt("Nowa data (RRRR-MM-DD, puste = bez zmian):", item.date || "");
      if (newDate === null) return;
      const newNotes = prompt("Nowa notatka (puste = bez zmian):", item.notes || "");
      if (newNotes === null) return;

      const currentPrioLabel = priorityLabel(item.priority || "normal");
      const newPrio = prompt("Priorytet (wysoki/normalny/niski, puste = bez zmian):", currentPrioLabel);
      if (newPrio === null) return;

      const currentRepeatLabel = repeatLabel(item.repeat || "none");
      const newRep = prompt("Powtarzanie (brak/tygodniowo/miesięcznie/rocznie, puste = bez zmian):", currentRepeatLabel);
      if (newRep === null) return;

      const currentImage = item.imageUrl || "";
      const newImg = prompt("Link do zdjęcia (puste = bez zmian, '-' aby usunąć):", currentImage);
      if (newImg === null) return;

      if (newTitle.trim() !== "") item.title = newTitle.trim();
      if (newDate.trim() !== "") item.date = newDate.trim();
      if (newNotes.trim() !== "") item.notes = newNotes.trim();

      if (newPrio.trim() !== "") {
        const p = newPrio.trim().toLowerCase();
        if (p.startsWith("wys")) item.priority = "high";
        else if (p.startsWith("nis")) item.priority = "low";
        else item.priority = "normal";
      }

      if (newRep.trim() !== "") {
        const r = newRep.trim().toLowerCase();
        if (r.startsWith("br")) item.repeat = "none";
        else if (r.startsWith("tyg")) item.repeat = "weekly";
        else if (r.startsWith("mies")) item.repeat = "monthly";
        else if (r.startsWith("roc")) item.repeat = "yearly";
      }

      const trimmedImg = newImg.trim();
      if (trimmedImg === "-") {
        item.imageUrl = "";
      } else if (trimmedImg !== "") {
        item.imageUrl = trimmedImg;
      }

      updateFn(item);
      saveState();
    }

    function renderTaskList(container, items, labelPrefix, updateArrayFn, deleteFn) {
      container.innerHTML = "";
      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.innerHTML = `<span class="muted">Brak zadań (${labelPrefix}).</span>`;
        container.appendChild(empty);
        return;
      }
      items
        .slice()
        .sort((a,b) => {
          const pA = priorityOrder(a.priority);
          const pB = priorityOrder(b.priority);
          if (pA !== pB) return pA - pB;
          return (a.date || "").localeCompare(b.date || "");
        })
        .forEach(item => {
          const card = document.createElement("div");
          card.className = "card";
          const dateLabel = item.date || "Bez daty";
          card.innerHTML = `
            <div class="card-header">
              <div>
                <div class="card-title">${item.title}</div>
                <div class="muted">${dateLabel}</div>
              </div>
            </div>
          `;
          const pills = document.createElement("div");
          pills.className = "pill-row";
          if (item.personIndex != null) {
            const p1 = document.createElement("span");
            p1.className = "pill pill-person";
            p1.textContent = personName(item.personIndex);
            pills.appendChild(p1);
          }
          if (item.priority && item.priority !== "normal") {
            const p2 = document.createElement("span");
            p2.className = "pill " + (item.priority === "high" ? "pill-prio-high" : "pill-prio-low");
            p2.textContent = "Priorytet: " + priorityLabel(item.priority);
            pills.appendChild(p2);
          }
          if (item.repeat && item.repeat !== "none") {
            const p3 = document.createElement("span");
            p3.className = "pill";
            p3.textContent = "Powtarzanie: " + repeatLabel(item.repeat);
            pills.appendChild(p3);
          }
          card.appendChild(pills);

          if (item.notes) {
            const p = document.createElement("p");
            p.style.marginTop = "4px";
            p.style.fontSize = "0.9rem";
            p.style.whiteSpace = "pre-wrap";
            p.textContent = item.notes;
            card.appendChild(p);
          }

          if (item.imageUrl) {
            const img = document.createElement("img");
            img.src = item.imageUrl;
            img.alt = "Zdjęcie";
            img.className = "task-image";
            card.appendChild(img);
          }

          const btnRow = document.createElement("div");
          btnRow.style.marginTop = "6px";
          btnRow.style.display = "flex";
          btnRow.style.justifyContent = "flex-end";

          const editBtn = document.createElement("button");
          editBtn.className = "btn-secondary";
          editBtn.textContent = "Zmień";
          editBtn.addEventListener("click", () => {
            editSimpleTask(item, updated => {
              updateArrayFn(updated);
            });
          });

          const delBtn = document.createElement("button");
          delBtn.className = "btn-danger";
          delBtn.textContent = "Usuń";
          delBtn.addEventListener("click", () => {
            deleteFn(item.id);
            saveState();
          });

          btnRow.appendChild(editBtn);
          btnRow.appendChild(delBtn);
          card.appendChild(btnRow);
          container.appendChild(card);
        });
    }

    function editBill(bill, updateFn) {
      const newName = prompt("Nazwa rachunku (puste = bez zmian):", bill.name || "");
      if (newName === null) return;
      const newDue = prompt("Termin (RRRR-MM-DD, puste = bez zmian):", bill.due || "");
      if (newDue === null) return;
      const newAmount = prompt("Kwota (puste = bez zmian):", bill.amount || "");
      if (newAmount === null) return;

      if (newName.trim() !== "") bill.name = newName.trim();
      if (newDue.trim() !== "") bill.due = newDue.trim();
      if (newAmount.trim() !== "") bill.amount = newAmount.trim();

      updateFn(bill);
      saveState();
    }

    function renderBillsList(container, items, placeLabel, updateArrayFn, deleteFn) {
      container.innerHTML = "";
      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.innerHTML = `<span class="muted">Brak rachunków (${placeLabel}).</span>`;
        container.appendChild(empty);
        return;
      }
      items
        .slice()
        .sort((a,b) => (a.due || "").localeCompare(b.due || ""))
        .forEach(b => {
          const card = document.createElement("div");
          card.className = "card";
          const dueLabel = b.due || "Brak terminu";
          const amountLabel = b.amount ? b.amount + " zł" : "-";
          card.innerHTML = `
            <div class="card-header">
              <div>
                <div class="card-title">${b.name}</div>
                <div class="muted">Termin: ${dueLabel}</div>
              </div>
              <span class="pill">${amountLabel}</span>
            </div>
          `;
          const btnRow = document.createElement("div");
          btnRow.style.marginTop = "6px";
          btnRow.style.display = "flex";
          btnRow.style.justifyContent = "flex-end";

          const editBtn = document.createElement("button");
          editBtn.className = "btn-secondary";
          editBtn.textContent = "Zmień";
          editBtn.addEventListener("click", () => {
            editBill(b, updated => {
              updateArrayFn(updated);
            });
          });

          const delBtn = document.createElement("button");
          delBtn.className = "btn-danger";
          delBtn.textContent = "Usuń";
          delBtn.addEventListener("click", () => {
            deleteFn(b.id);
            saveState();
          });
          btnRow.appendChild(editBtn);
          btnRow.appendChild(delBtn);
          card.appendChild(btnRow);
          container.appendChild(card);
        });
    }

    function renderLasocice(root) {
      root.innerHTML = "";

      const secDomList = document.createElement("div");
      secDomList.innerHTML = `<div class="section-label">Dom — lista zadań</div>`;
      const domListContainer = document.createElement("div");
      secDomList.appendChild(domListContainer);
      root.appendChild(secDomList);

      const secDzList = document.createElement("div");
      secDzList.innerHTML = `<div class="section-label">Działka — lista zadań</div>`;
      const dzListContainer = document.createElement("div");
      secDzList.appendChild(dzListContainer);
      root.appendChild(secDzList);

      const secBillsList = document.createElement("div");
      secBillsList.innerHTML = `<div class="section-label">Rachunki — lista</div>`;
      const billsContainer = document.createElement("div");
      secBillsList.appendChild(billsContainer);
      root.appendChild(secBillsList);

      const secDomForm = document.createElement("div");
      secDomForm.className = "card";
      secDomForm.innerHTML = `<div class="section-label">Dom — dodaj zadanie</div>`;
      const domForm = document.createElement("div");
      domForm.className = "two-cols";
      domForm.innerHTML = `
        <div>
          <div class="small-label">Tytuł</div>
          <input id="lasDomTitle" type="text" placeholder="Np. odkurzyć salon">
        </div>
        <div>
          <div class="small-label">Osoba</div>
          <select id="lasDomPerson"></select>
        </div>
        <div>
          <div class="small-label">Data</div>
          <input id="lasDomDate" type="date">
        </div>
        <div>
          <div class="small-label">Priorytet</div>
          <select id="lasDomPriority"></select>
        </div>
        <div>
          <div class="small-label">Powtarzanie</div>
          <select id="lasDomRepeat"></select>
        </div>
        <div>
          <div class="small-label">Link do zdjęcia (opcjonalnie)</div>
          <input id="lasDomImage" type="text" placeholder="https://...">
        </div>
        <div>
          <div class="small-label">Notatka</div>
          <textarea id="lasDomNotes" placeholder="Dodatkowe info (opcjonalne)"></textarea>
        </div>
      `;
      secDomForm.appendChild(domForm);
      const domBtnRow = document.createElement("div");
      domBtnRow.style.marginTop = "8px";
      domBtnRow.style.display = "flex";
      domBtnRow.style.justifyContent = "flex-end";
      const domBtn = document.createElement("button");
      domBtn.className = "btn-primary";
      domBtn.textContent = "Dodaj zadanie";
      domBtn.addEventListener("click", () => {
        const title = document.getElementById("lasDomTitle").value.trim();
        if (!title) { alert("Podaj tytuł."); return; }
        const personVal = document.getElementById("lasDomPerson").value;
        const personIndex = personVal === "" ? null : parseInt(personVal,10);
        const date = document.getElementById("lasDomDate").value;
        const notes = document.getElementById("lasDomNotes").value.trim();
        const priority = document.getElementById("lasDomPriority").value || "normal";
        const repeat = document.getElementById("lasDomRepeat").value || "none";
        const imageUrl = document.getElementById("lasDomImage").value.trim();

        state.lasociceDom.push({ id: Date.now(), title, personIndex, date, notes, priority, repeat, imageUrl });
        document.getElementById("lasDomTitle").value = "";
        document.getElementById("lasDomDate").value = "";
        document.getElementById("lasDomNotes").value = "";
        document.getElementById("lasDomImage").value = "";
        saveState();
      });
      domBtnRow.appendChild(domBtn);
      secDomForm.appendChild(domBtnRow);
      root.appendChild(secDomForm);

      const secDzForm = document.createElement("div");
      secDzForm.className = "card";
      secDzForm.innerHTML = `<div class="section-label">Działka — dodaj zadanie</div>`;
      const dzForm = document.createElement("div");
      dzForm.className = "two-cols";
      dzForm.innerHTML = `
        <div>
          <div class="small-label">Tytuł</div>
          <input id="lasDzTitle" type="text" placeholder="Np. skosić trawę">
        </div>
        <div>
          <div class="small-label">Osoba</div>
          <select id="lasDzPerson"></select>
        </div>
        <div>
          <div class="small-label">Data</div>
          <input id="lasDzDate" type="date">
        </div>
        <div>
          <div class="small-label">Priorytet</div>
          <select id="lasDzPriority"></select>
        </div>
        <div>
          <div class="small-label">Powtarzanie</div>
          <select id="lasDzRepeat"></select>
        </div>
        <div>
          <div class="small-label">Link do zdjęcia (opcjonalnie)</div>
          <input id="lasDzImage" type="text" placeholder="https://...">
        </div>
        <div>
          <div class="small-label">Notatka</div>
          <textarea id="lasDzNotes" placeholder="Dodatkowe info (opcjonalne)"></textarea>
        </div>
      `;
      secDzForm.appendChild(dzForm);
      const dzBtnRow = document.createElement("div");
      dzBtnRow.style.marginTop = "8px";
      dzBtnRow.style.display = "flex";
      dzBtnRow.style.justifyContent = "flex-end";
      const dzBtn = document.createElement("button");
      dzBtn.className = "btn-primary";
      dzBtn.textContent = "Dodaj zadanie";
      dzBtn.addEventListener("click", () => {
        const title = document.getElementById("lasDzTitle").value.trim();
        if (!title) { alert("Podaj tytuł."); return; }
        const personVal = document.getElementById("lasDzPerson").value;
        const personIndex = personVal === "" ? null : parseInt(personVal,10);
        const date = document.getElementById("lasDzDate").value;
        const notes = document.getElementById("lasDzNotes").value.trim();
        const priority = document.getElementById("lasDzPriority").value || "normal";
        const repeat = document.getElementById("lasDzRepeat").value || "none";
        const imageUrl = document.getElementById("lasDzImage").value.trim();

        state.lasociceDzialka.push({ id: Date.now(), title, personIndex, date, notes, priority, repeat, imageUrl });
        document.getElementById("lasDzTitle").value = "";
        document.getElementById("lasDzDate").value = "";
        document.getElementById("lasDzNotes").value = "";
        document.getElementById("lasDzImage").value = "";
        saveState();
      });
      dzBtnRow.appendChild(dzBtn);
      secDzForm.appendChild(dzBtnRow);
      root.appendChild(secDzForm);

      const secBillsForm = document.createElement("div");
      secBillsForm.className = "card";
      secBillsForm.innerHTML = `<div class="section-label">Rachunki — dodaj</div>`;
      const billForm = document.createElement("div");
      billForm.className = "two-cols";
      billForm.innerHTML = `
        <div>
          <div class="small-label">Nazwa rachunku</div>
          <input id="lasBillName" type="text" placeholder="Np. prąd, podatek">
        </div>
        <div>
          <div class="small-label">Kwota (opcjonalnie)</div>
          <input id="lasBillAmount" type="number" step="0.01">
        </div>
        <div>
          <div class="small-label">Termin</div>
          <input id="lasBillDue" type="date">
        </div>
      `;
      secBillsForm.appendChild(billForm);
      const billBtnRow = document.createElement("div");
      billBtnRow.style.marginTop = "8px";
      billBtnRow.style.display = "flex";
      billBtnRow.style.justifyContent = "flex-end";
      const billBtn = document.createElement("button");
      billBtn.className = "btn-primary";
      billBtn.textContent = "Dodaj rachunek";
      billBtn.addEventListener("click", () => {
        const name = document.getElementById("lasBillName").value.trim();
        const due = document.getElementById("lasBillDue").value;
        if (!name || !due) { alert("Podaj nazwę i termin rachunku."); return; }
        const amount = document.getElementById("lasBillAmount").value;
        state.lasociceBills.push({
          id: Date.now(),
          name,
          due,
          amount: amount ? amount : ""
        });
        document.getElementById("lasBillName").value = "";
        document.getElementById("lasBillAmount").value = "";
        document.getElementById("lasBillDue").value = "";
        saveState();
      });
      billBtnRow.appendChild(billBtn);
      secBillsForm.appendChild(billBtnRow);
      root.appendChild(secBillsForm);

      renderPersonSelect(document.getElementById("lasDomPerson"));
      renderPersonSelect(document.getElementById("lasDzPerson"));
      renderPrioritySelect(document.getElementById("lasDomPriority"));
      renderPrioritySelect(document.getElementById("lasDzPriority"));
      renderRepeatSelect(document.getElementById("lasDomRepeat"));
      renderRepeatSelect(document.getElementById("lasDzRepeat"));

      renderTaskList(
        domListContainer,
        state.lasociceDom,
        "Dom (Lasocice)",
        updated => {
          const idx = state.lasociceDom.findIndex(t => t.id === updated.id);
          if (idx !== -1) state.lasociceDom[idx] = updated;
        },
        id => {
          state.lasociceDom = state.lasociceDom.filter(t => t.id !== id);
        }
      );
      renderTaskList(
        dzListContainer,
        state.lasociceDzialka,
        "Działka (Lasocice)",
        updated => {
          const idx = state.lasociceDzialka.findIndex(t => t.id === updated.id);
          if (idx !== -1) state.lasociceDzialka[idx] = updated;
        },
        id => {
          state.lasociceDzialka = state.lasociceDzialka.filter(t => t.id !== id);
        }
      );
      renderBillsList(
        billsContainer,
        state.lasociceBills,
        "Lasocice",
        updated => {
          const idx = state.lasociceBills.findIndex(b => b.id === updated.id);
          if (idx !== -1) state.lasociceBills[idx] = updated;
        },
        id => {
          state.lasociceBills = state.lasociceBills.filter(b => b.id !== id);
        }
      );
    }

    function renderBoszkowo(root) {
      root.innerHTML = "";

      const secDomList = document.createElement("div");
      secDomList.innerHTML = `<div class="section-label">Dom — lista zadań</div>`;
      const domListContainer = document.createElement("div");
      secDomList.appendChild(domListContainer);
      root.appendChild(secDomList);

      const secDzList = document.createElement("div");
      secDzList.innerHTML = `<div class="section-label">Działka — lista zadań</div>`;
      const dzListContainer = document.createElement("div");
      secDzList.appendChild(dzListContainer);
      root.appendChild(secDzList);

      const secBillsList = document.createElement("div");
      secBillsList.innerHTML = `<div class="section-label">Rachunki — lista</div>`;
      const billsContainer = document.createElement("div");
      secBillsList.appendChild(billsContainer);
      root.appendChild(secBillsList);

      const secDomForm = document.createElement("div");
      secDomForm.className = "card";
      secDomForm.innerHTML = `<div class="section-label">Dom — dodaj zadanie</div>`;
      const domForm = document.createElement("div");
      domForm.className = "two-cols";
      domForm.innerHTML = `
        <div>
          <div class="small-label">Tytuł</div>
          <input id="bosDomTitle" type="text" placeholder="Np. posprzątać kuchnię">
        </div>
        <div>
          <div class="small-label">Osoba</div>
          <select id="bosDomPerson"></select>
        </div>
        <div>
          <div class="small-label">Data</div>
          <input id="bosDomDate" type="date">
        </div>
        <div>
          <div class="small-label">Priorytet</div>
          <select id="bosDomPriority"></select>
        </div>
        <div>
          <div class="small-label">Powtarzanie</div>
          <select id="bosDomRepeat"></select>
        </div>
        <div>
          <div class="small-label">Link do zdjęcia (opcjonalnie)</div>
          <input id="bosDomImage" type="text" placeholder="https://...">
        </div>
        <div>
          <div class="small-label">Notatka</div>
          <textarea id="bosDomNotes" placeholder="Dodatkowe info (opcjonalne)"></textarea>
        </div>
      `;
      secDomForm.appendChild(domForm);
      const domBtnRow = document.createElement("div");
      domBtnRow.style.marginTop = "8px";
      domBtnRow.style.display = "flex";
      domBtnRow.style.justifyContent = "flex-end";
      const domBtn = document.createElement("button");
      domBtn.className = "btn-primary";
      domBtn.textContent = "Dodaj zadanie";
      domBtn.addEventListener("click", () => {
        const title = document.getElementById("bosDomTitle").value.trim();
        if (!title) { alert("Podaj tytuł."); return; }
        const personVal = document.getElementById("bosDomPerson").value;
        const personIndex = personVal === "" ? null : parseInt(personVal,10);
        const date = document.getElementById("bosDomDate").value;
        const notes = document.getElementById("bosDomNotes").value.trim();
        const priority = document.getElementById("bosDomPriority").value || "normal";
        const repeat = document.getElementById("bosDomRepeat").value || "none";
        const imageUrl = document.getElementById("bosDomImage").value.trim();

        state.boszkowoDom.push({ id: Date.now(), title, personIndex, date, notes, priority, repeat, imageUrl });
        document.getElementById("bosDomTitle").value = "";
        document.getElementById("bosDomDate").value = "";
        document.getElementById("bosDomNotes").value = "";
        document.getElementById("bosDomImage").value = "";
        saveState();
      });
      domBtnRow.appendChild(domBtn);
      secDomForm.appendChild(domBtnRow);
      root.appendChild(secDomForm);

      const secDzForm = document.createElement("div");
      secDzForm.className = "card";
      secDzForm.innerHTML = `<div class="section-label">Działka — dodaj zadanie</div>`;
      const dzForm = document.createElement("div");
      dzForm.className = "two-cols";
      dzForm.innerHTML = `
        <div>
          <div class="small-label">Tytuł</div>
          <input id="bosDzTitle" type="text" placeholder="Np. przyciąć krzewy">
        </div>
        <div>
          <div class="small-label">Osoba</div>
          <select id="bosDzPerson"></select>
        </div>
        <div>
          <div class="small-label">Data</div>
          <input id="bosDzDate" type="date">
        </div>
        <div>
          <div class="small-label">Priorytet</div>
          <select id="bosDzPriority"></select>
        </div>
        <div>
          <div class="small-label">Powtarzanie</div>
          <select id="bosDzRepeat"></select>
        </div>
        <div>
          <div class="small-label">Link do zdjęcia (opcjonalnie)</div>
          <input id="bosDzImage" type="text" placeholder="https://...">
        </div>
        <div>
          <div class="small-label">Notatka</div>
          <textarea id="bosDzNotes" placeholder="Dodatkowe info (opcjonalne)"></textarea>
        </div>
      `;
      secDzForm.appendChild(dzForm);
      const dzBtnRow = document.createElement("div");
      dzBtnRow.style.marginTop = "8px";
      dzBtnRow.style.display = "flex";
      dzBtnRow.style.justifyContent = "flex-end";
      const dzBtn = document.createElement("button");
      dzBtn.className = "btn-primary";
      dzBtn.textContent = "Dodaj zadanie";
      dzBtn.addEventListener("click", () => {
        const title = document.getElementById("bosDzTitle").value.trim();
        if (!title) { alert("Podaj tytuł."); return; }
        const personVal = document.getElementById("bosDzPerson").value;
        const personIndex = personVal === "" ? null : parseInt(personVal,10);
        const date = document.getElementById("bosDzDate").value;
        const notes = document.getElementById("bosDzNotes").value.trim();
        const priority = document.getElementById("bosDzPriority").value || "normal";
        const repeat = document.getElementById("bosDzRepeat").value || "none";
        const imageUrl = document.getElementById("bosDzImage").value.trim();

        state.boszkowoDzialka.push({ id: Date.now(), title, personIndex, date, notes, priority, repeat, imageUrl });
        document.getElementById("bosDzTitle").value = "";
        document.getElementById("bosDzDate").value = "";
        document.getElementById("bosDzNotes").value = "";
        document.getElementById("bosDzImage").value = "";
        saveState();
      });
      dzBtnRow.appendChild(dzBtn);
      secDzForm.appendChild(dzBtnRow);
      root.appendChild(secDzForm);

      const secBillsForm = document.createElement("div");
      secBillsForm.className = "card";
      secBillsForm.innerHTML = `<div class="section-label">Rachunki — dodaj</div>`;
      const billForm = document.createElement("div");
      billForm.className = "two-cols";
      billForm.innerHTML = `
        <div>
          <div class="small-label">Nazwa rachunku</div>
          <input id="bosBillName" type="text" placeholder="Np. prąd, woda">
        </div>
        <div>
          <div class="small-label">Kwota (opcjonalnie)</div>
          <input id="bosBillAmount" type="number" step="0.01">
        </div>
        <div>
          <div class="small-label">Termin</div>
          <input id="bosBillDue" type="date">
        </div>
      `;
      secBillsForm.appendChild(billForm);
      const billBtnRow = document.createElement("div");
      billBtnRow.style.marginTop = "8px";
      billBtnRow.style.display = "flex";
      billBtnRow.style.justifyContent = "flex-end";
      const billBtn = document.createElement("button");
      billBtn.className = "btn-primary";
      billBtn.textContent = "Dodaj rachunek";
      billBtn.addEventListener("click", () => {
        const name = document.getElementById("bosBillName").value.trim();
        const due = document.getElementById("bosBillDue").value;
        if (!name || !due) { alert("Podaj nazwę i termin rachunku."); return; }
        const amount = document.getElementById("bosBillAmount").value;
        state.boszkowoBills.push({
          id: Date.now(),
          name,
          due,
          amount: amount ? amount : ""
        });
        document.getElementById("bosBillName").value = "";
        document.getElementById("bosBillAmount").value = "";
        document.getElementById("bosBillDue").value = "";
        saveState();
      });
      billBtnRow.appendChild(billBtn);
      secBillsForm.appendChild(billBtnRow);
      root.appendChild(secBillsForm);

      renderPersonSelect(document.getElementById("bosDomPerson"));
      renderPersonSelect(document.getElementById("bosDzPerson"));
      renderPrioritySelect(document.getElementById("bosDomPriority"));
      renderPrioritySelect(document.getElementById("bosDzPriority"));
      renderRepeatSelect(document.getElementById("bosDomRepeat"));
      renderRepeatSelect(document.getElementById("bosDzRepeat"));

      renderTaskList(
        domListContainer,
        state.boszkowoDom,
        "Dom (Boszkowo)",
        updated => {
          const idx = state.boszkowoDom.findIndex(t => t.id === updated.id);
          if (idx !== -1) state.boszkowoDom[idx] = updated;
        },
        id => {
          state.boszkowoDom = state.boszkowoDom.filter(t => t.id !== id);
        }
      );
      renderTaskList(
        dzListContainer,
        state.boszkowoDzialka,
        "Działka (Boszkowo)",
        updated => {
          const idx = state.boszkowoDzialka.findIndex(t => t.id === updated.id);
          if (idx !== -1) state.boszkowoDzialka[idx] = updated;
        },
        id => {
          state.boszkowoDzialka = state.boszkowoDzialka.filter(t => t.id !== id);
        }
      );
      renderBillsList(
        billsContainer,
        state.boszkowoBills,
        "Boszkowo",
        updated => {
          const idx = state.boszkowoBills.findIndex(b => b.id === updated.id);
          if (idx !== -1) state.boszkowoBills[idx] = updated;
        },
        id => {
          state.boszkowoBills = state.boszkowoBills.filter(b => b.id !== id);
        }
      );
    }

    function renderSimpleCategory(root, label, key) {
      root.innerHTML = "";

      const secList = document.createElement("div");
      secList.innerHTML = `<div class="section-label">${label} — lista</div>`;
      const listContainer = document.createElement("div");
      secList.appendChild(listContainer);
      root.appendChild(secList);

      const secForm = document.createElement("div");
      secForm.className = "card";
      secForm.innerHTML = `<div class="section-label">${label} — dodaj</div>`;
      const form = document.createElement("div");
      form.className = "two-cols";
      form.innerHTML = `
        <div>
          <div class="small-label">Tytuł</div>
          <input id="${key}Title" type="text" placeholder="Np. wymiana oleju / spotkanie / wyjazd">
        </div>
        <div>
          <div class="small-label">Osoba</div>
          <select id="${key}Person"></select>
        </div>
        <div>
          <div class="small-label">Data</div>
          <input id="${key}Date" type="date">
        </div>
        <div>
          <div class="small-label">Godzina (opcjonalnie)</div>
          <input id="${key}Time" type="time">
        </div>
        <div>
          <div class="small-label">Priorytet</div>
          <select id="${key}Priority"></select>
        </div>
        <div>
          <div class="small-label">Powtarzanie</div>
          <select id="${key}Repeat"></select>
        </div>
        <div>
          <div class="small-label">Link do zdjęcia (opcjonalnie)</div>
          <input id="${key}Image" type="text" placeholder="https://...">
        </div>
        <div>
          <div class="small-label">Notatka</div>
          <textarea id="${key}Notes" placeholder="Dodatkowe info (opcjonalne)"></textarea>
        </div>
      `;
      secForm.appendChild(form);
      const btnRow = document.createElement("div");
      btnRow.style.marginTop = "8px";
      btnRow.style.display = "flex";
      btnRow.style.justifyContent = "flex-end";
      const btn = document.createElement("button");
      btn.className = "btn-primary";
      btn.textContent = "Dodaj";
      btn.addEventListener("click", () => {
        const title = document.getElementById(key + "Title").value.trim();
        const date = document.getElementById(key + "Date").value;
        if (!title || !date) { alert("Podaj tytuł i datę."); return; }
        const personVal = document.getElementById(key + "Person").value;
        const personIndex = personVal === "" ? null : parseInt(personVal,10);
        const time = document.getElementById(key + "Time").value;
        const notes = document.getElementById(key + "Notes").value.trim();
        const priority = document.getElementById(key + "Priority").value || "normal";
        const repeat = document.getElementById(key + "Repeat").value || "none";
        const imageUrl = document.getElementById(key + "Image").value.trim();

        state[key].push({ id: Date.now(), title, personIndex, date, time, notes, priority, repeat, imageUrl });
        document.getElementById(key + "Title").value = "";
        document.getElementById(key + "Date").value = "";
        document.getElementById(key + "Time").value = "";
        document.getElementById(key + "Notes").value = "";
        document.getElementById(key + "Image").value = "";
        saveState();
      });
      btnRow.appendChild(btn);
      secForm.appendChild(btnRow);
      root.appendChild(secForm);

      renderPersonSelect(document.getElementById(key + "Person"));
      renderPrioritySelect(document.getElementById(key + "Priority"));
      renderRepeatSelect(document.getElementById(key + "Repeat"));

      renderTaskList(
        listContainer,
        state[key],
        label,
        updated => {
          const idx = state[key].findIndex(t => t.id === updated.id);
          if (idx !== -1) state[key][idx] = updated;
        },
        id => {
          state[key] = state[key].filter(t => t.id !== id);
        }
      );
    }

    function renderZdrowie(root) {
      root.innerHTML = "";

      const secList = document.createElement("div");
      secList.innerHTML = `<div class="section-label">Zdrowie — lista wizyt</div>`;
      const listContainer = document.createElement("div");
      secList.appendChild(listContainer);
      root.appendChild(secList);

      const secForm = document.createElement("div");
      secForm.className = "card";
      secForm.innerHTML = `<div class="section-label">Zdrowie — dodaj wizytę</div>`;
      const form = document.createElement("div");
      form.className = "two-cols";
      form.innerHTML = `
        <div>
          <div class="small-label">Osoba</div>
          <select id="zdPerson"></select>
        </div>
        <div>
          <div class="small-label">Typ wizyty</div>
          <select id="zdType">
            <option value="Lekarz rodzinny">Lekarz rodzinny</option>
            <option value="Specjalista">Specjalista</option>
            <option value="Dentysta">Dentysta</option>
            <option value="Inne">Inne</option>
          </select>
        </div>
        <div>
          <div class="small-label">Data</div>
          <input id="zdDate" type="date">
        </div>
        <div>
          <div class="small-label">Godzina (opcjonalnie)</div>
          <input id="zdTime" type="time">
        </div>
        <div>
          <div class="small-label">Miejsce (opcjonalnie)</div>
          <input id="zdPlace" type="text" placeholder="Np. przychodnia">
        </div>
        <div>
          <div class="small-label">Priorytet</div>
          <select id="zdPriority"></select>
        </div>
        <div>
          <div class="small-label">Powtarzanie</div>
          <select id="zdRepeat"></select>
        </div>
        <div>
          <div class="small-label">Notatka</div>
          <textarea id="zdNotes" placeholder="Dodatkowe info (opcjonalne)"></textarea>
        </div>
      `;
      secForm.appendChild(form);
      const btnRow = document.createElement("div");
      btnRow.style.marginTop = "8px";
      btnRow.style.display = "flex";
      btnRow.style.justifyContent = "flex-end";
      const btn = document.createElement("button");
      btn.className = "btn-primary";
      btn.textContent = "Dodaj wizytę";
      btn.addEventListener("click", () => {
        const personVal = document.getElementById("zdPerson").value;
        const date = document.getElementById("zdDate").value;
        if (personVal === "" || !date) { alert("Wybierz osobę i datę."); return; }
        const personIndex = parseInt(personVal,10);
        const type = document.getElementById("zdType").value;
        const time = document.getElementById("zdTime").value;
        const place = document.getElementById("zdPlace").value.trim();
        const notes = document.getElementById("zdNotes").value.trim();
        const priority = document.getElementById("zdPriority").value || "normal";
        const repeat = document.getElementById("zdRepeat").value || "none";

        state.zdrowie.push({
          id: Date.now(), personIndex, type, date, time, place, notes, priority, repeat
        });
        document.getElementById("zdDate").value = "";
        document.getElementById("zdTime").value = "";
        document.getElementById("zdPlace").value = "";
        document.getElementById("zdNotes").value = "";
        saveState();
      });
      btnRow.appendChild(btn);
      secForm.appendChild(btnRow);
      root.appendChild(secForm);

      renderPersonSelect(document.getElementById("zdPerson"));
      renderPrioritySelect(document.getElementById("zdPriority"));
      renderRepeatSelect(document.getElementById("zdRepeat"));

      listContainer.innerHTML = "";
      if (!state.zdrowie.length) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.innerHTML = `<span class="muted">Brak wizyt zdrowotnych.</span>`;
        listContainer.appendChild(empty);
      } else {
        state.zdrowie
          .slice()
          .sort((a,b) => {
            const pA = priorityOrder(a.priority);
            const pB = priorityOrder(b.priority);
            if (pA !== pB) return pA - pB;
            return (a.date || "").localeCompare(b.date || "");
          })
          .forEach(item => {
            const card = document.createElement("div");
            card.className = "card";
            const dateLabel = item.date || "Bez daty";
            const time = item.time ? (" • " + item.time) : "";
            card.innerHTML = `
              <div class="card-header">
                <div>
                  <div class="card-title">${item.type}</div>
                  <div class="muted">${dateLabel}${time}</div>
                </div>
                <span class="pill pill-person">${personName(item.personIndex)}</span>
              </div>
            `;
            const pills = document.createElement("div");
            pills.className = "pill-row";
            if (item.priority && item.priority !== "normal") {
              const pPrio = document.createElement("span");
              pPrio.className = "pill " + (item.priority === "high" ? "pill-prio-high" : "pill-prio-low");
              pPrio.textContent = "Priorytet: " + priorityLabel(item.priority);
              pills.appendChild(pPrio);
            }
            if (item.repeat && item.repeat !== "none") {
              const pRep = document.createElement("span");
              pRep.className = "pill";
              pRep.textContent = "Powtarzanie: " + repeatLabel(item.repeat);
              pills.appendChild(pRep);
            }
            if (item.place) {
              const p1 = document.createElement("span");
              p1.className = "pill";
              p1.textContent = item.place;
              pills.appendChild(p1);
            }
            card.appendChild(pills);
            if (item.notes) {
              const p = document.createElement("p");
              p.style.marginTop = "4px";
              p.style.fontSize = "0.9rem";
              p.style.whiteSpace = "pre-wrap";
              p.textContent = item.notes;
              card.appendChild(p);
            }
            const btnRowX = document.createElement("div");
            btnRowX.style.marginTop = "6px";
            btnRowX.style.display = "flex";
            btnRowX.style.justifyContent = "flex-end";

            const editBtn = document.createElement("button");
            editBtn.className = "btn-secondary";
            editBtn.textContent = "Zmień";
            editBtn.addEventListener("click", () => {
              editSimpleTask(item, updated => {
                const idx = state.zdrowie.findIndex(x => x.id === updated.id);
                if (idx !== -1) state.zdrowie[idx] = updated;
              });
            });

            const delBtn = document.createElement("button");
            delBtn.className = "btn-danger";
            delBtn.textContent = "Usuń";
            delBtn.addEventListener("click", () => {
              state.zdrowie = state.zdrowie.filter(x => x.id !== item.id);
              saveState();
            });

            btnRowX.appendChild(editBtn);
            btnRowX.appendChild(delBtn);
            card.appendChild(btnRowX);
            listContainer.appendChild(card);
          });
      }
    }

    function renderOsoby(root) {
      root.innerHTML = "";

      const sec = document.createElement("div");
      sec.className = "card";
      sec.innerHTML = `
        <div class="section-label">Osoby</div>
        <p class="muted" style="margin-bottom:6px;">
          Wybierz poziom: ${personName(0)}, ${personName(1)} albo cała Rodzina (wszyscy członkowie).
        </p>
      `;
      const btnRow = document.createElement("div");
      btnRow.className = "person-btn-row";

      function makeBtn(label, indices) {
        const b = document.createElement("button");
        b.className = "person-btn";
        b.textContent = label;
        b.addEventListener("click", () => renderPersonOverview(indices, label));
        btnRow.appendChild(b);
      }

      const persons = getPersonNames();
      makeBtn(persons[0] || "Jacek", [0]);
      makeBtn(persons[1] || "Grażyna", [1]);
      makeBtn("Rodzina (wszyscy członkowie)", [2,3,4,5,6,7]);

      sec.appendChild(btnRow);
      root.appendChild(sec);

      const inner = document.createElement("div");
      inner.id = "osobyInner";
      root.appendChild(inner);
    }

    function renderPersonOverview(personIndexes, label) {
      const inner = document.getElementById("osobyInner");
      inner.innerHTML = "";

      const tasks = [];

      function addTaskFromArray(arr, categoryLabel, mapper) {
        arr.forEach(item => {
          if (item.personIndex != null && personIndexes.includes(item.personIndex)) {
            const mapped = mapper ? mapper(item) : item;
            tasks.push({
              title: mapped.title,
              date: mapped.date || "",
              info: mapped.info || "",
              category: categoryLabel
            });
          }
        });
      }

      addTaskFromArray(state.lasociceDom, getCategoryLabel("lasocice","Lasocice") + " – Dom", item => ({
        title: item.title, date: item.date, info: item.notes || ""
      }));
      addTaskFromArray(state.lasociceDzialka, getCategoryLabel("lasocice","Lasocice") + " – Działka", item => ({
        title: item.title, date: item.date, info: item.notes || ""
      }));
      addTaskFromArray(state.boszkowoDom, getCategoryLabel("boszkowo","Boszkowo") + " – Dom", item => ({
        title: item.title, date: item.date, info: item.notes || ""
      }));
      addTaskFromArray(state.boszkowoDzialka, getCategoryLabel("boszkowo","Boszkowo") + " – Działka", item => ({
        title: item.title, date: item.date, info: item.notes || ""
      }));

      addTaskFromArray(state.auto, getCategoryLabel("auto","Auto"), item => ({
        title: item.title,
        date: item.date,
        info: (item.time ? ("Godzina: " + item.time + " ") : "") + (item.notes || "")
      }));
      addTaskFromArray(state.firma, getCategoryLabel("firma","Firma"), item => ({
        title: item.title,
        date: item.date,
        info: (item.time ? ("Godzina: " + item.time + " ") : "") + (item.notes || "")
      }));
      addTaskFromArray(state.czaswolny, getCategoryLabel("czaswolny","Czas wolny"), item => ({
        title: item.title,
        date: item.date,
        info: (item.time ? ("Godzina: " + item.time + " ") : "") + (item.notes || "")
      }));

      addTaskFromArray(state.zdrowie, getCategoryLabel("zdrowie","Zdrowie"), item => ({
        title: item.type,
        date: item.date,
        info:
          (item.time ? ("Godzina: " + item.time + " ") : "") +
          (item.place ? ("Miejsce: " + item.place + " ") : "") +
          (item.notes || "")
      }));

      const header = document.createElement("div");
      header.className = "section-label";
      header.textContent = "Zadania dla: " + label;
      inner.appendChild(header);

      if (!tasks.length) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.innerHTML = `<span class="muted">Brak zadań przypisanych do tej osoby / grupy.</span>`;
        inner.appendChild(empty);
        return;
      }

      tasks
        .sort((a,b) => (a.date || "").localeCompare(b.date || ""))
        .forEach(t => {
          const card = document.createElement("div");
          card.className = "card";
          const dateLabel = t.date || "Bez daty";
          card.innerHTML = `
            <div class="card-header">
              <div>
                <div class="card-title">${t.title}</div>
                <div class="muted">${t.category} • ${dateLabel}</div>
              </div>
            </div>
          `;
          if (t.info) {
            const p = document.createElement("p");
            p.style.marginTop = "4px";
            p.style.fontSize = "0.9rem";
            p.style.whiteSpace = "pre-wrap";
            p.textContent = t.info;
            card.appendChild(p);
          }
          inner.appendChild(card);
        });
    }

    function renderCustomSimpleCategory(root, cat) {
      root.innerHTML = "";

      const tasks = ensureCustomData(cat.id);

      const secList = document.createElement("div");
      secList.innerHTML = `<div class="section-label">${cat.name} — lista</div>`;
      const listContainer = document.createElement("div");
      secList.appendChild(listContainer);
      root.appendChild(secList);

      if (!tasks.length) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.innerHTML = `<span class="muted">Brak zadań.</span>`;
        listContainer.appendChild(empty);
      } else {
        tasks
          .slice()
          .sort((a,b) => {
            const pA = priorityOrder(a.priority);
            const pB = priorityOrder(b.priority);
            if (pA !== pB) return pA - pB;
            return (a.date || "").localeCompare(b.date || "");
          })
          .forEach(item => {
            const card = document.createElement("div");
            card.className = "card";
            const dateLabel = item.date || "Bez daty";
            card.innerHTML = `
              <div class="card-header">
                <div>
                  <div class="card-title">${item.title}</div>
                  <div class="muted">${dateLabel}</div>
                </div>
              </div>
            `;
            const pills = document.createElement("div");
            pills.className = "pill-row";
            if (item.personIndex != null) {
              const p1 = document.createElement("span");
              p1.className = "pill pill-person";
              p1.textContent = personName(item.personIndex);
              pills.appendChild(p1);
            }
            if (item.priority && item.priority !== "normal") {
              const p2 = document.createElement("span");
              p2.className = "pill " + (item.priority === "high" ? "pill-prio-high" : "pill-prio-low");
              p2.textContent = "Priorytet: " + priorityLabel(item.priority);
              pills.appendChild(p2);
            }
            if (item.repeat && item.repeat !== "none") {
              const p3 = document.createElement("span");
              p3.className = "pill";
              p3.textContent = "Powtarzanie: " + repeatLabel(item.repeat);
              pills.appendChild(p3);
            }
            card.appendChild(pills);
            if (item.notes) {
              const p = document.createElement("p");
              p.style.marginTop = "4px";
              p.style.fontSize = "0.9rem";
              p.style.whiteSpace = "pre-wrap";
              p.textContent = item.notes;
              card.appendChild(p);
            }
            if (item.imageUrl) {
              const img = document.createElement("img");
              img.src = item.imageUrl;
              img.alt = "Zdjęcie";
              img.className = "task-image";
              card.appendChild(img);
            }
            const btnRow = document.createElement("div");
            btnRow.style.marginTop = "6px";
            btnRow.style.display = "flex";
            btnRow.style.justifyContent = "flex-end";

            const editBtn = document.createElement("button");
            editBtn.className = "btn-secondary";
            editBtn.textContent = "Zmień";
            editBtn.addEventListener("click", () => {
              editSimpleTask(item, updated => {
                const arr = ensureCustomData(cat.id);
                const idx = arr.findIndex(t => t.id === updated.id);
                if (idx !== -1) arr[idx] = updated;
                state.customData[cat.id] = arr;
              });
            });

            const delBtn = document.createElement("button");
            delBtn.className = "btn-danger";
            delBtn.textContent = "Usuń";
            delBtn.addEventListener("click", () => {
              state.customData[cat.id] = ensureCustomData(cat.id).filter(t => t.id !== item.id);
              saveState();
            });

            btnRow.appendChild(editBtn);
            btnRow.appendChild(delBtn);
            card.appendChild(btnRow);
            listContainer.appendChild(card);
          });
      }

      const secForm = document.createElement("div");
      secForm.className = "card";
      secForm.innerHTML = `<div class="section-label">${cat.name} — dodaj zadanie</div>`;
      const form = document.createElement("div");
      form.className = "two-cols";
      const catKey = "custom_" + cat.id;
      form.innerHTML = `
        <div>
          <div class="small-label">Tytuł</div>
          <input id="${catKey}Title" type="text" placeholder="Opis zadania">
        </div>
        <div>
          <div class="small-label">Osoba</div>
          <select id="${catKey}Person"></select>
        </div>
        <div>
          <div class="small-label">Data</div>
          <input id="${catKey}Date" type="date">
        </div>
        <div>
          <div class="small-label">Godzina (opcjonalnie)</div>
          <input id="${catKey}Time" type="time">
        </div>
        <div>
          <div class="small-label">Priorytet</div>
          <select id="${catKey}Priority"></select>
        </div>
        <div>
          <div class="small-label">Powtarzanie</div>
          <select id="${catKey}Repeat"></select>
        </div>
        <div>
          <div class="small-label">Link do zdjęcia (opcjonalnie)</div>
          <input id="${catKey}Image" type="text" placeholder="https://...">
        </div>
        <div>
          <div class="small-label">Notatka</div>
          <textarea id="${catKey}Notes" placeholder="Dodatkowe info (opcjonalne)"></textarea>
        </div>
      `;
      secForm.appendChild(form);
      const btnRow = document.createElement("div");
      btnRow.style.marginTop = "8px";
      btnRow.style.display = "flex";
      btnRow.style.justifyContent = "flex-end";
      const btn = document.createElement("button");
      btn.className = "btn-primary";
      btn.textContent = "Dodaj";
      btn.addEventListener("click", () => {
        const title = document.getElementById(catKey + "Title").value.trim();
        const date = document.getElementById(catKey + "Date").value;
        if (!title || !date) { alert("Podaj tytuł i datę."); return; }
        const personVal = document.getElementById(catKey + "Person").value;
        const personIndex = personVal === "" ? null : parseInt(personVal,10);
        const time = document.getElementById(catKey + "Time").value;
        const notes = document.getElementById(catKey + "Notes").value.trim();
        const priority = document.getElementById(catKey + "Priority").value || "normal";
        const repeat = document.getElementById(catKey + "Repeat").value || "none";
        const imageUrl = document.getElementById(catKey + "Image").value.trim();
        const arr = ensureCustomData(cat.id);
        arr.push({ id: Date.now(), title, personIndex, date, time, notes, priority, repeat, imageUrl });
        state.customData[cat.id] = arr;
        document.getElementById(catKey + "Title").value = "";
        document.getElementById(catKey + "Date").value = "";
        document.getElementById(catKey + "Time").value = "";
        document.getElementById(catKey + "Notes").value = "";
        document.getElementById(catKey + "Image").value = "";
        saveState();
      });
      btnRow.appendChild(btn);
      secForm.appendChild(btnRow);
      root.appendChild(secForm);

      renderPersonSelect(document.getElementById(catKey + "Person"));
      renderPrioritySelect(document.getElementById(catKey + "Priority"));
      renderRepeatSelect(document.getElementById(catKey + "Repeat"));
    }

    function renderEvents(root) {
      root.innerHTML = "";

      const secList = document.createElement("div");
      secList.innerHTML = `<div class="section-label">Ur/Im/Rocznice — lista</div>`;
      const listContainer = document.createElement("div");
      secList.appendChild(listContainer);
      root.appendChild(secList);

      const events = state.events || [];
      if (!events.length) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.innerHTML = `<span class="muted">Brak uroczystości.</span>`;
        listContainer.appendChild(empty);
      } else {
        events
          .slice()
          .sort((a,b) => (a.date || "").localeCompare(b.date || ""))
          .forEach(ev => {
            const card = document.createElement("div");
            card.className = "card";
            const dateLabel = ev.date || "Brak daty";
            const kindLabel = ev.kind === "imieniny" ? "Imieniny" : (ev.kind === "rocznica" ? "Rocznica" : "Urodziny");
            let extra = "";
            if (ev.kind === "urodziny") {
              const age = calcAge(ev.date);
              if (age != null) extra = " (" + age + " lat)";
            }
            card.innerHTML = `
              <div class="card-header">
                <div>
                  <div class="card-title">${kindLabel}: ${ev.personName || "-" }${extra}</div>
                  <div class="muted">${dateLabel}</div>
                </div>
              </div>
            `;
            if (ev.notes) {
              const p = document.createElement("p");
              p.style.marginTop = "4px";
              p.style.fontSize = "0.9rem";
              p.style.whiteSpace = "pre-wrap";
              p.textContent = ev.notes;
              card.appendChild(p);
            }
            const btnRow = document.createElement("div");
            btnRow.style.marginTop = "6px";
            btnRow.style.display = "flex";
            btnRow.style.justifyContent = "flex-end";

            const editBtn = document.createElement("button");
            editBtn.className = "btn-secondary";
            editBtn.textContent = "Zmień";
            editBtn.addEventListener("click", () => {
              const newName = prompt("Imię / osoba (puste = bez zmian):", ev.personName || "");
              if (newName === null) return;
              const newKind = prompt("Typ (urodziny/imieniny/rocznica, puste = bez zmian):", ev.kind || "urodziny");
              if (newKind === null) return;
              const newDate = prompt("Data (RRRR-MM-DD, puste = bez zmian):", ev.date || "");
              if (newDate === null) return;
              const newNotes = prompt("Notatka (puste = bez zmian):", ev.notes || "");
              if (newNotes === null) return;

              if (newName.trim() !== "") ev.personName = newName.trim();
              if (newKind.trim() !== "") {
                const k = newKind.trim().toLowerCase();
                if (k.startsWith("imi")) ev.kind = "imieniny";
                else if (k.startsWith("roc")) ev.kind = "rocznica";
                else ev.kind = "urodziny";
              }
              if (newDate.trim() !== "") ev.date = newDate.trim();
              if (newNotes.trim() !== "") ev.notes = newNotes.trim();

              saveState();
            });

            const delBtn = document.createElement("button");
            delBtn.className = "btn-danger";
            delBtn.textContent = "Usuń";
            delBtn.addEventListener("click", () => {
              state.events = (state.events || []).filter(x => x.id !== ev.id);
              saveState();
            });

            btnRow.appendChild(editBtn);
            btnRow.appendChild(delBtn);
            card.appendChild(btnRow);
            listContainer.appendChild(card);
          });
      }

      const secForm = document.createElement("div");
      secForm.className = "card";
      secForm.innerHTML = `<div class="section-label">Ur/Im/Rocznice — dodaj uroczystość</div>`;
      const form = document.createElement("div");
      form.className = "two-cols";
      form.innerHTML = `
        <div>
          <div class="small-label">Imię / osoba</div>
          <input id="evName" type="text" placeholder="Np. Krzysiu">
        </div>
        <div>
          <div class="small-label">Typ</div>
          <select id="evKind">
            <option value="urodziny">Urodziny</option>
            <option value="imieniny">Imieniny</option>
            <option value="rocznica">Rocznica</option>
          </select>
        </div>
        <div>
          <div class="small-label">Data</div>
          <input id="evDate" type="date">
        </div>
        <div>
          <div class="small-label">Notatka (opcjonalnie)</div>
          <textarea id="evNotes" placeholder="Np. miejsce, prezent, uwagi"></textarea>
        </div>
      `;
      secForm.appendChild(form);
      const btnRow = document.createElement("div");
      btnRow.style.marginTop = "8px";
      btnRow.style.display = "flex";
      btnRow.style.justifyContent = "flex-end";
      const btn = document.createElement("button");
      btn.className = "btn-primary";
      btn.textContent = "Dodaj uroczystość";
      btn.addEventListener("click", () => {
        const name = document.getElementById("evName").value.trim();
        const kind = document.getElementById("evKind").value;
        const date = document.getElementById("evDate").value;
        const notes = document.getElementById("evNotes").value.trim();
        if (!name || !date) {
          alert("Podaj imię i datę.");
          return;
        }
        state.events.push({
          id: Date.now(),
          personName: name,
          kind,
          date,
          notes
        });
        document.getElementById("evName").value = "";
        document.getElementById("evDate").value = "";
        document.getElementById("evNotes").value = "";
        saveState();
      });
      btnRow.appendChild(btn);
      secForm.appendChild(btnRow);
      root.appendChild(secForm);
    }

    function renderSettings() {
      const homeInput = document.getElementById("settingsHomeName");
      if (homeInput) {
        homeInput.value = state.settings.homeName || "Dom Nowaka";
      }

      const catsContainer = document.getElementById("settingsCategories");
      catsContainer.innerHTML = "";

      const vis = state.settings.visibleCategories || {};
      const labels = state.settings.categoryLabels || {};
      const colors = state.settings.categoryColors || {};

      const builtHeader = document.createElement("div");
      builtHeader.className = "small-label";
      builtHeader.textContent = "Kategorie wbudowane:";
      catsContainer.appendChild(builtHeader);

      BUILTIN_CATEGORIES.forEach(c => {
        const row = document.createElement("div");
        row.className = "settings-row";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = vis[c.key] !== false;
        cb.addEventListener("change", () => {
          state.settings.visibleCategories[c.key] = cb.checked;
          saveState();
        });

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.style.flex = "1";
        nameInput.value = getCategoryLabel(c.key, c.defaultLabel);
        nameInput.addEventListener("change", () => {
          const val = nameInput.value.trim() || c.defaultLabel;
          state.settings.categoryLabels[c.key] = val;
          saveState();
        });

        const colorInput = document.createElement("input");
        colorInput.type = "color";
        colorInput.value = getCategoryColorRaw(c.key);
        colorInput.addEventListener("input", () => {
          state.settings.categoryColors[c.key] = colorInput.value;
          saveState();
        });

        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger";
        delBtn.textContent = "Usuń";
        delBtn.addEventListener("click", () => {
          deleteBuiltinCategory(c.key);
        });

        row.appendChild(cb);
        row.appendChild(nameInput);
        row.appendChild(colorInput);
        row.appendChild(delBtn);
        catsContainer.appendChild(row);
      });

      const customHeader = document.createElement("div");
      customHeader.className = "small-label";
      customHeader.style.marginTop = "8px";
      customHeader.textContent = "Twoje własne kategorie:";
      catsContainer.appendChild(customHeader);

      (state.customCategories || []).forEach(cat => {
        const row = document.createElement("div");
        row.className = "settings-row";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = cat.visible !== false;
        cb.addEventListener("change", () => {
          cat.visible = cb.checked;
          saveState();
        });

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.style.flex = "1";
        nameInput.value = cat.name || "";
        nameInput.addEventListener("change", () => {
          cat.name = nameInput.value.trim() || "Nowa kategoria";
          saveState();
        });

        const colorInput = document.createElement("input");
        colorInput.type = "color";
        const cKey = getCustomCategoryColorKey(cat.id);
        colorInput.value = colors[cKey] || "#6b7280";
        colorInput.addEventListener("input", () => {
          state.settings.categoryColors[cKey] = colorInput.value;
          saveState();
        });

        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger";
        delBtn.textContent = "Usuń";
        delBtn.addEventListener("click", () => {
          if (!confirm("Usunąć tę kategorię i wszystkie jej zadania?")) return;
          state.customCategories = state.customCategories.filter(c2 => c2.id !== cat.id);
          if (state.customData && state.customData[cat.id]) {
            delete state.customData[cat.id];
          }
          saveState();
          renderSettings();
        });

        row.appendChild(cb);
        row.appendChild(nameInput);
        row.appendChild(colorInput);
        row.appendChild(delBtn);
        catsContainer.appendChild(row);
      });

      const addBox = document.createElement("div");
      addBox.style.marginTop = "8px";
      const addLabel = document.createElement("div");
      addLabel.className = "small-label";
      addLabel.textContent = "Dodaj nową kategorię (zwykła lista zadań):";
      addBox.appendChild(addLabel);

      const addRow = document.createElement("div");
      addRow.className = "settings-row";

      const addName = document.createElement("input");
      addName.type = "text";
      addName.placeholder = "Nazwa (np. Remonty, Projekty...)";
      addName.style.flex = "1";

      const addBtn = document.createElement("button");
      addBtn.className = "btn-primary";
      addBtn.textContent = "Dodaj";
      addBtn.addEventListener("click", () => {
        const name = addName.value.trim();
        if (!name) {
          alert("Podaj nazwę kategorii.");
          return;
        }
        const newId = Date.now();
        state.customCategories.push({
          id: newId,
          name,
          visible: true
        });
        ensureCustomData(newId);
        const cKey = getCustomCategoryColorKey(newId);
        state.settings.categoryColors[cKey] = "#6b7280";
        addName.value = "";
        saveState();
        renderSettings();
      });

      addRow.appendChild(addName);
      addRow.appendChild(addBtn);
      addBox.appendChild(addRow);
      catsContainer.appendChild(addBox);

      const personsContainer = document.getElementById("settingsPersons");
      personsContainer.innerHTML = "";
      const persons = getPersonNames();
      for (let idx = 0; idx < persons.length; idx++) {
        const row = document.createElement("div");
        row.className = "settings-row";
        const label = document.createElement("span");
        label.style.minWidth = "110px";
        if (idx === 0) label.textContent = "Jacek:";
        else if (idx === 1) label.textContent = "Grażyna:";
        else label.textContent = "Osoba rodziny " + (idx - 1) + ":";

        const input = document.createElement("input");
        input.type = "text";
        input.value = persons[idx] || "";
        input.placeholder = idx < 2 ? "" : "np. syn, córka, wnuk...";
        input.dataset.personIndex = idx;

        row.appendChild(label);
        row.appendChild(input);
        personsContainer.appendChild(row);
      }
    }

    function deleteBuiltinCategory(key) {
      if (!confirm("Na pewno usunąć tę kategorię i powiązane dane?")) return;

      state.settings.visibleCategories[key] = false;

      if (key === "lasocice") {
        state.lasociceDom = [];
        state.lasociceDzialka = [];
        state.lasociceBills = [];
      } else if (key === "boszkowo") {
        state.boszkowoDom = [];
        state.boszkowoDzialka = [];
        state.boszkowoBills = [];
      } else if (key === "auto") {
        state.auto = [];
      } else if (key === "firma") {
        state.firma = [];
      } else if (key === "czaswolny") {
        state.czaswolny = [];
      } else if (key === "zdrowie") {
        state.zdrowie = [];
      } else if (key === "events") {
        state.events = [];
      } else if (key === "osoby") {
      }
      saveState();
      renderSettings();
    }

    function saveHomeName() {
      const homeInput = document.getElementById("settingsHomeName");
      if (!homeInput) return;
      const val = homeInput.value.trim();
      if (!val) {
        alert("Podaj nazwę domu.");
        return;
      }
      state.settings.homeName = val;
      saveState();
    }

    function savePersonNames() {
      const personsContainer = document.getElementById("settingsPersons");
      const inputs = personsContainer.querySelectorAll("input[data-person-index]");
      const arr = getPersonNames().slice();
      inputs.forEach(input => {
        const idx = parseInt(input.dataset.personIndex,10);
        let val = input.value.trim();
        if (idx === 0 && !val) val = "Jacek";
        if (idx === 1 && !val) val = "Grażyna";
        arr[idx] = val;
      });
      state.settings.personNames = arr;
      saveState();
      renderSettings();
    }

    function exportData() {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "dom-nowaka-export-" + todayISO() + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importData(evt) {
  const file = evt.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const loaded = JSON.parse(e.target.result);
      if (!loaded || typeof loaded !== "object") {
        throw new Error("Zły format");
      }

      if (!confirm("Zastąpić aktualne dane danymi z pliku?")) return;

      // Nadpisujemy stan aplikacji danymi z pliku
      state = Object.assign({}, state, loaded);
      ensureSettingsDefaults();
      saveState();
      alert("Dane zaimportowane.");
    } catch (err) {
      console.error(err);
      alert("Nie udało się wczytać pliku. Upewnij się, że to plik eksportu z tej aplikacji.");
    } finally {
      // czyścimy input, żeby można było później znowu wybrać ten sam plik
      evt.target.value = "";
    }
  };
  reader.readAsText(file);
}

loadState();
    applyDynamicTexts();
    renderTodayHeader();
    renderCategoriesTiles();
    updateFilterButtons();
    renderDashboard();
  </script>
</body>
</html>
